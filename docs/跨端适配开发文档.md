# u-kit 跨端适配开发文档

## 概述

kit-ui 组件库基于 uni-app x 框架，支持 H5、小程序（微信、支付宝、百度、字节跳动）、App（iOS、Android）、鸿蒙等多端平台。本文档详细说明跨端开发的适配策略、注意事项和最佳实践。

---

## 1. 平台差异分析

### 1.1 渲染引擎差异

```typescript
// 平台检测工具
class PlatformDetector {
  // 获取当前平台
  static getCurrentPlatform(): string {
    // #ifdef H5
    return 'h5';
    // #endif
    
    // #ifdef MP-WEIXIN
    return 'mp-weixin';
    // #endif
    
    // #ifdef MP-ALIPAY
    return 'mp-alipay';
    // #endif
    
    // #ifdef MP-BAIDU
    return 'mp-baidu';
    // #endif
    
    // #ifdef MP-TOUTIAO
    return 'mp-toutiao';
    // #endif
    
    // #ifdef APP-PLUS
    return 'app';
    // #endif
    
    // #ifdef APP-HARMONY
    return 'harmony';
    // #endif
    
    return 'unknown';
  }
  
  // 判断是否为小程序
  static isMiniProgram(): boolean {
    const platform = this.getCurrentPlatform();
    return platform.startsWith('mp-');
  }
  
  // 判断是否为 App
  static isApp(): boolean {
    const platform = this.getCurrentPlatform();
    return platform === 'app' || platform === 'harmony';
  }
  
  // 判断是否为 H5
  static isH5(): boolean {
    return this.getCurrentPlatform() === 'h5';
  }
  
  // 获取平台能力
  static getPlatformCapabilities() {
    const platform = this.getCurrentPlatform();
    
    const capabilities = {
      'h5': {
        supportsShadowDOM: true,
        supportsCustomElements: true,
        supportsWebComponents: true,
        supportsCSS3: true,
        supportsES6: true,
        supportsWebGL: true,
        supportsCanvas: true,
        supportsVideo: true,
        supportsAudio: true,
        supportsGeolocation: true,
        supportsCamera: false,
        supportsFileSystem: false,
        supportsPush: false
      },
      'mp-weixin': {
        supportsShadowDOM: false,
        supportsCustomElements: false,
        supportsWebComponents: false,
        supportsCSS3: true,
        supportsES6: true,
        supportsWebGL: false,
        supportsCanvas: true,
        supportsVideo: true,
        supportsAudio: true,
        supportsGeolocation: true,
        supportsCamera: true,
        supportsFileSystem: true,
        supportsPush: true
      },
      'app': {
        supportsShadowDOM: false,
        supportsCustomElements: false,
        supportsWebComponents: false,
        supportsCSS3: true,
        supportsES6: true,
        supportsWebGL: true,
        supportsCanvas: true,
        supportsVideo: true,
        supportsAudio: true,
        supportsGeolocation: true,
        supportsCamera: true,
        supportsFileSystem: true,
        supportsPush: true
      }
    };
    
    return capabilities[platform] || capabilities['h5'];
  }
}
```

### 1.2 CSS 特性支持差异

```scss
// CSS 特性适配混入
@mixin platform-specific($property, $h5-value, $mp-value: null, $app-value: null) {
  #{$property}: $h5-value;
  
  /* #ifdef MP */
  @if $mp-value {
    #{$property}: $mp-value;
  }
  /* #endif */
  
  /* #ifdef APP-PLUS */
  @if $app-value {
    #{$property}: $app-value;
  }
  /* #endif */
}

// 阴影适配
@mixin box-shadow($shadow) {
  /* #ifdef H5 */
  box-shadow: $shadow;
  /* #endif */
  
  /* #ifdef MP */
  // 小程序使用边框模拟阴影
  border: 1px solid rgba(0, 0, 0, 0.1);
  /* #endif */
  
  /* #ifdef APP-PLUS */
  // App 使用原生阴影
  box-shadow: $shadow;
  /* #endif */
}

// 渐变适配
@mixin linear-gradient($direction, $color-stops...) {
  /* #ifdef H5 */
  background: linear-gradient($direction, $color-stops);
  /* #endif */
  
  /* #ifdef MP */
  // 小程序部分支持渐变
  background: linear-gradient($direction, $color-stops);
  /* #endif */
  
  /* #ifdef APP-PLUS */
  background: linear-gradient($direction, $color-stops);
  /* #endif */
}

// 变换适配
@mixin transform($transform) {
  /* #ifdef H5 */
  transform: $transform;
  /* #endif */
  
  /* #ifdef MP */
  // 小程序支持基础变换
  transform: $transform;
  /* #endif */
  
  /* #ifdef APP-PLUS */
  transform: $transform;
  /* #endif */
}
```

---

## 2. 组件跨端适配策略

### 2.1 条件编译适配

```vue
<!-- k-button.vue -->
<template>
  <!-- H5 平台使用 button 标签 -->
  <!-- #ifdef H5 -->
  <button 
    class="k-button"
    :class="buttonClass"
    :disabled="disabled || loading"
    @click="handleClick"
  >
    <slot></slot>
  </button>
  <!-- #endif -->
  
  <!-- 小程序平台使用 view 标签 -->
  <!-- #ifdef MP -->
  <view 
    class="k-button"
    :class="buttonClass"
    :hover-class="disabled || loading ? '' : 'k-button--active'"
    :hover-stay-time="150"
    @tap="handleClick"
  >
    <slot></slot>
  </view>
  <!-- #endif -->
  
  <!-- App 平台使用 view 标签 -->
  <!-- #ifdef APP-PLUS -->
  <view 
    class="k-button"
    :class="buttonClass"
    @click="handleClick"
  >
    <slot></slot>
  </view>
  <!-- #endif -->
</template>

<script setup>
import { computed } from 'vue';
import { PlatformDetector } from '../utils/platform';

interface Props {
  type?: 'primary' | 'default' | 'ghost';
  size?: 'small' | 'medium' | 'large';
  disabled?: boolean;
  loading?: boolean;
  block?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  type: 'default',
  size: 'medium',
  disabled: false,
  loading: false,
  block: false
});

const emit = defineEmits<{
  click: [event: Event];
}>();

const buttonClass = computed(() => {
  const platform = PlatformDetector.getCurrentPlatform();
  
  return [
    `k-button--${props.type}`,
    `k-button--${props.size}`,
    `k-button--${platform}`,
    {
      'k-button--disabled': props.disabled,
      'k-button--loading': props.loading,
      'k-button--block': props.block
    }
  ];
});

function handleClick(event: Event) {
  if (props.disabled || props.loading) return;
  
  // 平台特定的点击反馈
  if (PlatformDetector.isApp()) {
    // App 平台添加触觉反馈
    // #ifdef APP-PLUS
    uni.vibrateShort();
    // #endif
  }
  
  emit('click', event);
}
</script>

<style lang="scss">
.k-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: $spacing-sm $spacing-base;
  border-radius: $radius-base;
  font-size: $font-size-base;
  line-height: 1.4;
  text-align: center;
  cursor: pointer;
  user-select: none;
  transition: all $animation-duration-base;
  
  // H5 平台特定样式
  &--h5 {
    border: none;
    outline: none;
    @include box-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    
    &:hover:not(.k-button--disabled) {
      transform: translateY(-1px);
      @include box-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
    }
    
    &:active:not(.k-button--disabled) {
      transform: translateY(0);
    }
  }
  
  // 小程序平台特定样式
  &--mp-weixin,
  &--mp-alipay,
  &--mp-baidu,
  &--mp-toutiao {
    border: 1px solid transparent;
    
    &.k-button--active {
      opacity: 0.8;
      transform: scale(0.98);
    }
  }
  
  // App 平台特定样式
  &--app {
    @include box-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }
  
  // 类型样式
  &--primary {
    background-color: $primary-color;
    color: white;
    
    &.k-button--h5:hover:not(.k-button--disabled) {
      background-color: lighten($primary-color, 5%);
    }
  }
  
  &--default {
    background-color: $bg-color-container;
    color: $text-color-primary;
    border-color: $border-color;
  }
  
  &--ghost {
    background-color: transparent;
    color: $primary-color;
    border-color: $primary-color;
  }
  
  // 尺寸样式
  &--small {
    padding: $spacing-xs $spacing-sm;
    font-size: $font-size-sm;
  }
  
  &--large {
    padding: $spacing-base $spacing-lg;
    font-size: $font-size-lg;
  }
  
  // 状态样式
  &--disabled {
    opacity: 0.5;
    cursor: not-allowed;
    
    &.k-button--h5 {
      pointer-events: none;
    }
  }
  
  &--loading {
    pointer-events: none;
  }
  
  &--block {
    width: 100%;
    display: flex;
  }
}
</style>
```

### 2.2 API 适配层

```typescript
// 跨端 API 适配
class CrossPlatformAPI {
  // 统一的存储 API
  static setStorage(key: string, value: any): Promise<void> {
    return new Promise((resolve, reject) => {
      try {
        // #ifdef H5
        localStorage.setItem(key, JSON.stringify(value));
        resolve();
        // #endif
        
        // #ifndef H5
        uni.setStorage({
          key,
          data: value,
          success: () => resolve(),
          fail: (error) => reject(error)
        });
        // #endif
      } catch (error) {
        reject(error);
      }
    });
  }
  
  static getStorage(key: string): Promise<any> {
    return new Promise((resolve, reject) => {
      try {
        // #ifdef H5
        const value = localStorage.getItem(key);
        resolve(value ? JSON.parse(value) : null);
        // #endif
        
        // #ifndef H5
        uni.getStorage({
          key,
          success: (res) => resolve(res.data),
          fail: () => resolve(null)
        });
        // #endif
      } catch (error) {
        reject(error);
      }
    });
  }
  
  // 统一的网络请求
  static request(options: any): Promise<any> {
    return new Promise((resolve, reject) => {
      // #ifdef H5
      fetch(options.url, {
        method: options.method || 'GET',
        headers: options.header || {},
        body: options.data ? JSON.stringify(options.data) : undefined
      })
      .then(response => response.json())
      .then(data => resolve({ data }))
      .catch(error => reject(error));
      // #endif
      
      // #ifndef H5
      uni.request({
        ...options,
        success: (res) => resolve(res),
        fail: (error) => reject(error)
      });
      // #endif
    });
  }
  
  // 统一的文件上传
  static uploadFile(options: any): Promise<any> {
    return new Promise((resolve, reject) => {
      // #ifdef H5
      const formData = new FormData();
      formData.append('file', options.filePath);
      
      fetch(options.url, {
        method: 'POST',
        headers: options.header || {},
        body: formData
      })
      .then(response => response.json())
      .then(data => resolve({ data }))
      .catch(error => reject(error));
      // #endif
      
      // #ifndef H5
      uni.uploadFile({
        ...options,
        success: (res) => resolve(res),
        fail: (error) => reject(error)
      });
      // #endif
    });
  }
  
  // 统一的图片选择
  static chooseImage(options: any = {}): Promise<any> {
    return new Promise((resolve, reject) => {
      // #ifdef H5
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = options.count > 1;
      
      input.onchange = (event: any) => {
        const files = Array.from(event.target.files);
        const tempFilePaths = files.map(file => URL.createObjectURL(file));
        resolve({ tempFilePaths });
      };
      
      input.click();
      // #endif
      
      // #ifndef H5
      uni.chooseImage({
        count: options.count || 1,
        sizeType: options.sizeType || ['original', 'compressed'],
        sourceType: options.sourceType || ['album', 'camera'],
        success: (res) => resolve(res),
        fail: (error) => reject(error)
      });
      // #endif
    });
  }
  
  // 统一的系统信息获取
  static getSystemInfo(): Promise<any> {
    return new Promise((resolve, reject) => {
      // #ifdef H5
      const systemInfo = {
        platform: 'web',
        system: navigator.platform,
        version: navigator.appVersion,
        screenWidth: window.screen.width,
        screenHeight: window.screen.height,
        windowWidth: window.innerWidth,
        windowHeight: window.innerHeight,
        pixelRatio: window.devicePixelRatio || 1,
        language: navigator.language
      };
      resolve(systemInfo);
      // #endif
      
      // #ifndef H5
      uni.getSystemInfo({
        success: (res) => resolve(res),
        fail: (error) => reject(error)
      });
      // #endif
    });
  }
}
```

---

## 3. 样式跨端适配

### 3.1 单位适配

```scss
// 单位适配函数
@function adaptive-size($size) {
  /* #ifdef H5 */
  @return #{$size}px;
  /* #endif */
  
  /* #ifdef MP */
  @return #{$size * 2}rpx; // 小程序使用 rpx
  /* #endif */
  
  /* #ifdef APP-PLUS */
  @return #{$size}px;
  /* #endif */
}

// 字体大小适配
@mixin font-size($size) {
  /* #ifdef H5 */
  font-size: #{$size}px;
  /* #endif */
  
  /* #ifdef MP */
  font-size: #{$size * 2}rpx;
  /* #endif */
  
  /* #ifdef APP-PLUS */
  font-size: #{$size}px;
  /* #endif */
}

// 间距适配
@mixin spacing($property, $value) {
  /* #ifdef H5 */
  #{$property}: #{$value}px;
  /* #endif */
  
  /* #ifdef MP */
  #{$property}: #{$value * 2}rpx;
  /* #endif */
  
  /* #ifdef APP-PLUS */
  #{$property}: #{$value}px;
  /* #endif */
}

// 使用示例
.u-card {
  @include spacing(padding, 16);
  @include spacing(margin, 12);
  @include font-size(14);
  border-radius: adaptive-size(8);
}
```

### 3.2 布局适配

```scss
// Flex 布局适配
.u-flex {
  display: flex;
  
  /* #ifdef MP-ALIPAY */
  // 支付宝小程序 flex 兼容性处理
  display: -webkit-flex;
  /* #endif */
  
  &--column {
    flex-direction: column;
    
    /* #ifdef MP-ALIPAY */
    -webkit-flex-direction: column;
    /* #endif */
  }
  
  &--center {
    align-items: center;
    justify-content: center;
    
    /* #ifdef MP-ALIPAY */
    -webkit-align-items: center;
    -webkit-justify-content: center;
    /* #endif */
  }
}

// Grid 布局适配
.u-grid {
  /* #ifdef H5 */
  display: grid;
  /* #endif */
  
  /* #ifdef MP */
  // 小程序使用 flex 模拟 grid
  display: flex;
  flex-wrap: wrap;
  /* #endif */
  
  /* #ifdef APP-PLUS */
  display: flex;
  flex-wrap: wrap;
  /* #endif */
  
  &--cols-2 {
    /* #ifdef H5 */
    grid-template-columns: repeat(2, 1fr);
    /* #endif */
    
    /* #ifndef H5 */
    .u-grid__item {
      width: 50%;
    }
    /* #endif */
  }
  
  &--cols-3 {
    /* #ifdef H5 */
    grid-template-columns: repeat(3, 1fr);
    /* #endif */
    
    /* #ifndef H5 */
    .u-grid__item {
      width: 33.333%;
    }
    /* #endif */
  }
}
```

### 3.3 动画适配

```scss
// 动画适配
@mixin animation($name, $duration: 0.3s, $timing: ease-in-out) {
  /* #ifdef H5 */
  animation: $name $duration $timing;
  /* #endif */
  
  /* #ifdef MP */
  // 小程序使用 transition 替代复杂动画
  transition: all $duration $timing;
  /* #endif */
  
  /* #ifdef APP-PLUS */
  animation: $name $duration $timing;
  /* #endif */
}

// 变换动画
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    transform: translateX(-100%);
  }
  to {
    transform: translateX(0);
  }
}

// 使用示例
.u-modal {
  @include animation(fadeIn, 0.3s);
  
  &__content {
    @include animation(slideIn, 0.3s, ease-out);
  }
}
```

---

## 4. 事件处理适配

### 4.1 事件统一处理

```typescript
// 事件适配器
class EventAdapter {
  // 统一的点击事件
  static onClick(handler: (event: any) => void) {
    return (event: any) => {
      // 阻止默认行为
      if (event.preventDefault) {
        event.preventDefault();
      }
      
      // 阻止冒泡
      if (event.stopPropagation) {
        event.stopPropagation();
      }
      
      // 统一事件对象
      const normalizedEvent = {
        type: event.type,
        target: event.target || event.currentTarget,
        detail: event.detail || {},
        touches: event.touches || [],
        changedTouches: event.changedTouches || [],
        timeStamp: event.timeStamp || Date.now()
      };
      
      handler(normalizedEvent);
    };
  }
  
  // 统一的触摸事件
  static onTouch(handlers: {
    onTouchStart?: (event: any) => void;
    onTouchMove?: (event: any) => void;
    onTouchEnd?: (event: any) => void;
  }) {
    const normalizeTouch = (event: any) => ({
      type: event.type,
      touches: event.touches || [],
      changedTouches: event.changedTouches || [],
      timeStamp: event.timeStamp || Date.now()
    });
    
    return {
      onTouchstart: handlers.onTouchStart ? 
        (event: any) => handlers.onTouchStart!(normalizeTouch(event)) : undefined,
      onTouchmove: handlers.onTouchMove ? 
        (event: any) => handlers.onTouchMove!(normalizeTouch(event)) : undefined,
      onTouchend: handlers.onTouchEnd ? 
        (event: any) => handlers.onTouchEnd!(normalizeTouch(event)) : undefined
    };
  }
  
  // 统一的输入事件
  static onInput(handler: (value: string, event: any) => void) {
    return (event: any) => {
      const value = event.detail?.value || event.target?.value || '';
      handler(value, event);
    };
  }
}
```

### 4.2 手势识别适配

```typescript
// 手势识别
class GestureRecognizer {
  private startX: number = 0;
  private startY: number = 0;
  private startTime: number = 0;
  
  // 滑动手势识别
  recognizeSwipe(event: any): {
    direction: 'left' | 'right' | 'up' | 'down' | null;
    distance: number;
    duration: number;
  } {
    const touch = event.changedTouches[0];
    const endX = touch.clientX || touch.pageX;
    const endY = touch.clientY || touch.pageY;
    const endTime = Date.now();
    
    const deltaX = endX - this.startX;
    const deltaY = endY - this.startY;
    const duration = endTime - this.startTime;
    
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    // 最小滑动距离和时间
    if (distance < 30 || duration > 1000) {
      return { direction: null, distance: 0, duration };
    }
    
    // 判断方向
    let direction: 'left' | 'right' | 'up' | 'down' | null = null;
    
    if (Math.abs(deltaX) > Math.abs(deltaY)) {
      // 水平滑动
      direction = deltaX > 0 ? 'right' : 'left';
    } else {
      // 垂直滑动
      direction = deltaY > 0 ? 'down' : 'up';
    }
    
    return { direction, distance, duration };
  }
  
  // 长按手势识别
  recognizeLongPress(callback: () => void, delay: number = 500): {
    onTouchStart: (event: any) => void;
    onTouchEnd: (event: any) => void;
    onTouchMove: (event: any) => void;
  } {
    let timer: any = null;
    let isLongPress = false;
    
    return {
      onTouchStart: (event: any) => {
        const touch = event.touches[0];
        this.startX = touch.clientX || touch.pageX;
        this.startY = touch.clientY || touch.pageY;
        this.startTime = Date.now();
        isLongPress = false;
        
        timer = setTimeout(() => {
          isLongPress = true;
          callback();
        }, delay);
      },
      
      onTouchMove: (event: any) => {
        const touch = event.touches[0];
        const currentX = touch.clientX || touch.pageX;
        const currentY = touch.clientY || touch.pageY;
        
        // 移动超过阈值取消长按
        const distance = Math.sqrt(
          Math.pow(currentX - this.startX, 2) + 
          Math.pow(currentY - this.startY, 2)
        );
        
        if (distance > 10) {
          clearTimeout(timer);
        }
      },
      
      onTouchEnd: () => {
        clearTimeout(timer);
      }
    };
  }
}
```

---

## 5. 性能优化适配

### 5.1 渲染性能优化

```typescript
// 性能监控
class PerformanceMonitor {
  private static instance: PerformanceMonitor;
  private metrics: Map<string, number> = new Map();
  
  static getInstance(): PerformanceMonitor {
    if (!this.instance) {
      this.instance = new PerformanceMonitor();
    }
    return this.instance;
  }
  
  // 标记性能点
  mark(name: string) {
    // #ifdef H5
    if (performance && performance.mark) {
      performance.mark(name);
    }
    // #endif
    
    this.metrics.set(name, Date.now());
  }
  
  // 测量性能
  measure(name: string, startMark: string, endMark?: string) {
    const endTime = endMark ? this.metrics.get(endMark) : Date.now();
    const startTime = this.metrics.get(startMark);
    
    if (startTime && endTime) {
      const duration = endTime - startTime;
      
      // #ifdef H5
      if (performance && performance.measure) {
        performance.measure(name, startMark, endMark);
      }
      // #endif
      
      console.log(`Performance [${name}]: ${duration}ms`);
      return duration;
    }
    
    return 0;
  }
  
  // 获取平台特定的性能信息
  getPlatformPerformance() {
    const platform = PlatformDetector.getCurrentPlatform();
    
    switch (platform) {
      case 'h5':
        return this.getH5Performance();
      case 'mp-weixin':
        return this.getMiniProgramPerformance();
      case 'app':
        return this.getAppPerformance();
      default:
        return {};
    }
  }
  
  private getH5Performance() {
    // #ifdef H5
    if (performance && performance.getEntriesByType) {
      const navigation = performance.getEntriesByType('navigation')[0] as any;
      const paint = performance.getEntriesByType('paint');
      
      return {
        domContentLoaded: navigation?.domContentLoadedEventEnd - navigation?.domContentLoadedEventStart,
        loadComplete: navigation?.loadEventEnd - navigation?.loadEventStart,
        firstPaint: paint.find(p => p.name === 'first-paint')?.startTime,
        firstContentfulPaint: paint.find(p => p.name === 'first-contentful-paint')?.startTime
      };
    }
    // #endif
    
    return {};
  }
  
  private getMiniProgramPerformance() {
    // #ifdef MP
    // 小程序性能监控
    return {
      // 可以通过 uni.getPerformance() 获取
    };
    // #endif
    
    return {};
  }
  
  private getAppPerformance() {
    // #ifdef APP-PLUS
    // App 性能监控
    return {
      // 可以通过原生插件获取
    };
    // #endif
    
    return {};
  }
}
```

### 5.2 内存管理适配

```typescript
// 内存管理
class MemoryManager {
  private static observers: Set<any> = new Set();
  private static timers: Set<any> = new Set();
  
  // 注册观察者
  static registerObserver(observer: any) {
    this.observers.add(observer);
  }
  
  // 注册定时器
  static registerTimer(timer: any) {
    this.timers.add(timer);
  }
  
  // 清理资源
  static cleanup() {
    // 清理观察者
    this.observers.forEach(observer => {
      if (observer && typeof observer.disconnect === 'function') {
        observer.disconnect();
      }
    });
    this.observers.clear();
    
    // 清理定时器
    this.timers.forEach(timer => {
      clearTimeout(timer);
      clearInterval(timer);
    });
    this.timers.clear();
    
    // 平台特定清理
    const platform = PlatformDetector.getCurrentPlatform();
    
    if (platform === 'h5') {
      this.cleanupH5Resources();
    } else if (platform.startsWith('mp-')) {
      this.cleanupMiniProgramResources();
    } else if (platform === 'app') {
      this.cleanupAppResources();
    }
  }
  
  private static cleanupH5Resources() {
    // #ifdef H5
    // 清理 H5 特定资源
    if (window.removeEventListener) {
      // 移除全局事件监听器
    }
    // #endif
  }
  
  private static cleanupMiniProgramResources() {
    // #ifdef MP
    // 清理小程序特定资源
    // #endif
  }
  
  private static cleanupAppResources() {
    // #ifdef APP-PLUS
    // 清理 App 特定资源
    // #endif
  }
  
  // 监控内存使用
  static monitorMemoryUsage() {
    const platform = PlatformDetector.getCurrentPlatform();
    
    if (platform === 'h5') {
      // #ifdef H5
      if (performance && (performance as any).memory) {
        const memory = (performance as any).memory;
        return {
          used: memory.usedJSHeapSize,
          total: memory.totalJSHeapSize,
          limit: memory.jsHeapSizeLimit
        };
      }
      // #endif
    }
    
    return null;
  }
}
```

---

## 6. 调试与测试适配

### 6.1 跨端调试工具

```typescript
// 调试工具
class DebugTool {
  private static isDebugMode: boolean = false;
  
  // 启用调试模式
  static enableDebug() {
    this.isDebugMode = true;
    
    // 平台特定调试设置
    const platform = PlatformDetector.getCurrentPlatform();
    
    if (platform === 'h5') {
      this.enableH5Debug();
    } else if (platform.startsWith('mp-')) {
      this.enableMiniProgramDebug();
    } else if (platform === 'app') {
      this.enableAppDebug();
    }
  }
  
  // 日志输出
  static log(message: string, data?: any) {
    if (!this.isDebugMode) return;
    
    const platform = PlatformDetector.getCurrentPlatform();
    const timestamp = new Date().toISOString();
    
    console.log(`[${platform}] ${timestamp}: ${message}`, data || '');
    
    // 平台特定日志处理
    if (platform.startsWith('mp-')) {
      // 小程序可能需要特殊的日志处理
      this.logToMiniProgram(message, data);
    }
  }
  
  // 错误报告
  static reportError(error: Error, context?: any) {
    const platform = PlatformDetector.getCurrentPlatform();
    const errorInfo = {
      platform,
      message: error.message,
      stack: error.stack,
      context,
      timestamp: Date.now(),
      userAgent: this.getUserAgent()
    };
    
    console.error('Error Report:', errorInfo);
    
    // 发送错误报告到服务器
    this.sendErrorReport(errorInfo);
  }
  
  private static enableH5Debug() {
    // #ifdef H5
    // 启用 H5 调试工具
    if (window.console) {
      console.log('H5 Debug Mode Enabled');
    }
    // #endif
  }
  
  private static enableMiniProgramDebug() {
    // #ifdef MP
    // 启用小程序调试
    console.log('MiniProgram Debug Mode Enabled');
    // #endif
  }
  
  private static enableAppDebug() {
    // #ifdef APP-PLUS
    // 启用 App 调试
    console.log('App Debug Mode Enabled');
    // #endif
  }
  
  private static logToMiniProgram(message: string, data?: any) {
    // #ifdef MP
    // 小程序特定日志处理
    // #endif
  }
  
  private static getUserAgent(): string {
    // #ifdef H5
    return navigator.userAgent;
    // #endif
    
    // #ifndef H5
    return PlatformDetector.getCurrentPlatform();
    // #endif
  }
  
  private static async sendErrorReport(errorInfo: any) {
    try {
      await CrossPlatformAPI.request({
        url: '/api/error-report',
        method: 'POST',
        data: errorInfo
      });
    } catch (error) {
      console.error('Failed to send error report:', error);
    }
  }
}
```

### 6.2 自动化测试适配

```typescript
// 测试工具
class TestUtils {
  // 模拟平台环境
  static mockPlatform(platform: string) {
    // 设置全局变量模拟不同平台
    (global as any).__PLATFORM__ = platform;
  }
  
  // 模拟 uni API
  static mockUniAPI() {
    const mockUni = {
      getSystemInfoSync: () => ({
        platform: 'test',
        system: 'test',
        version: '1.0.0',
        screenWidth: 375,
        screenHeight: 667,
        windowWidth: 375,
        windowHeight: 667,
        pixelRatio: 2,
        language: 'zh-CN'
      }),
      
      setStorage: ({ key, data, success }: any) => {
        localStorage.setItem(key, JSON.stringify(data));
        success && success();
      },
      
      getStorage: ({ key, success, fail }: any) => {
        const data = localStorage.getItem(key);
        if (data) {
          success && success({ data: JSON.parse(data) });
        } else {
          fail && fail();
        }
      },
      
      request: ({ url, method, data, success, fail }: any) => {
        // 模拟网络请求
        setTimeout(() => {
          if (url.includes('error')) {
            fail && fail(new Error('Network Error'));
          } else {
            success && success({ data: { code: 200, message: 'success' } });
          }
        }, 100);
      }
    };
    
    (global as any).uni = mockUni;
  }
  
  // 测试组件在不同平台的渲染
  static async testCrossPlatformRendering(component: any, platforms: string[]) {
    const results: any[] = [];
    
    for (const platform of platforms) {
      this.mockPlatform(platform);
      
      // 渲染组件
      const wrapper = mount(component);
      
      // 收集渲染结果
      results.push({
        platform,
        html: wrapper.html(),
        classes: wrapper.classes(),
        props: wrapper.props()
      });
      
      wrapper.unmount();
    }
    
    return results;
  }
}
```

---

## 7. 发布与部署适配

### 7.1 构建配置

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import uni from '@dcloudio/vite-plugin-uni';

export default defineConfig({
  plugins: [uni()],
  
  // 平台特定配置
  define: {
    __PLATFORM__: JSON.stringify(process.env.UNI_PLATFORM)
  },
  
  build: {
    // 不同平台的构建优化
    rollupOptions: {
      output: {
        manualChunks: (id) => {
          // 根据平台分包
          if (id.includes('node_modules')) {
            return 'vendor';
          }
          
          if (id.includes('components')) {
            return 'components';
          }
          
          if (id.includes('utils')) {
            return 'utils';
          }
        }
      }
    },
    
    // 平台特定的压缩配置
    terserOptions: {
      compress: {
        // 移除 console.log（生产环境）
        drop_console: process.env.NODE_ENV === 'production',
        // 移除 debugger
        drop_debugger: true
      }
    }
  },
  
  // CSS 处理
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `
          @import "@/styles/variables.scss";
          @import "@/styles/mixins.scss";
        `
      }
    }
  }
});
```

### 7.2 部署脚本

```bash
#!/bin/bash
# deploy.sh

# 构建不同平台
echo "Building for different platforms..."

# H5 构建
echo "Building H5..."
npm run build:h5

# 小程序构建
echo "Building MiniProgram..."
npm run build:mp-weixin
npm run build:mp-alipay
npm run build:mp-baidu
npm run build:mp-toutiao

# App 构建
echo "Building App..."
npm run build:app

# 鸿蒙构建
echo "Building Harmony..."
npm run build:app-harmony

echo "All platforms built successfully!"

# 部署到不同环境
if [ "$1" = "production" ]; then
  echo "Deploying to production..."
  
  # 部署 H5 到 CDN
  aws s3 sync dist/build/h5 s3://your-bucket/h5/
  
  # 上传小程序到各平台
  # 这里可以集成各平台的 CLI 工具
  
else
  echo "Deploying to staging..."
  # 部署到测试环境
fi
```

通过以上跨端适配策略，u-kit 组件库能够在不同平台上提供一致的用户体验，同时充分利用各平台的特性和优势，确保组件的稳定性和性能。
