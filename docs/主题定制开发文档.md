# kit-ui 主题定制开发文档

## 概述

kit-ui 组件库基于 SCSS 变量系统实现主题定制，支持亮色/暗色模式切换，提供灵活的视觉风格配置能力。

---

## 1. 主题系统架构

### 1.1 SCSS 变量体系

```scss
// 主色系
$primary-color: #007AFF !default;        // 主品牌色
$secondary-color: #5856D6 !default;      // 辅助色
$success-color: #34C759 !default;        // 成功色
$warning-color: #FF9500 !default;        // 警告色
$error-color: #FF3B30 !default;          // 错误色
$info-color: #5AC8FA !default;           // 信息色

// 中性色系
$text-color-primary: #000000 !default;   // 主文本色
$text-color-secondary: #666666 !default; // 次要文本色
$text-color-placeholder: #999999 !default; // 占位符文本色
$text-color-disabled: #CCCCCC !default;  // 禁用文本色

// 背景色系
$bg-color-page: #F5F5F5 !default;        // 页面背景色
$bg-color-container: #FFFFFF !default;   // 容器背景色
$bg-color-mask: rgba(0, 0, 0, 0.5) !default; // 遮罩背景色

// 边框色系
$border-color: #E5E5E5 !default;         // 默认边框色
$border-color-light: #F0F0F0 !default;   // 浅色边框
$border-color-dark: #D0D0D0 !default;    // 深色边框

// 尺寸系统
$radius-small: 4px !default;             // 小圆角
$radius-base: 8px !default;              // 基础圆角
$radius-large: 12px !default;            // 大圆角
$radius-round: 50% !default;             // 圆形

// 间距系统
$spacing-xs: 4px !default;               // 超小间距
$spacing-sm: 8px !default;               // 小间距
$spacing-base: 12px !default;            // 基础间距
$spacing-lg: 16px !default;              // 大间距
$spacing-xl: 24px !default;              // 超大间距

// 字体系统
$font-size-xs: 10px !default;            // 超小字号
$font-size-sm: 12px !default;            // 小字号
$font-size-base: 14px !default;          // 基础字号
$font-size-lg: 16px !default;            // 大字号
$font-size-xl: 18px !default;            // 超大字号
$font-size-xxl: 20px !default;           // 特大字号

// 动画系统
$animation-duration-fast: 0.2s !default; // 快速动画
$animation-duration-base: 0.3s !default; // 基础动画
$animation-duration-slow: 0.5s !default; // 慢速动画
$animation-timing-function: ease-in-out !default; // 动画曲线
```

### 1.2 暗色主题变量

```scss
// 暗色主题色彩映射
$dark-theme: (
  // 主色系（保持不变）
  primary-color: #007AFF,
  secondary-color: #5856D6,
  success-color: #30D158,
  warning-color: #FF9F0A,
  error-color: #FF453A,
  info-color: #64D2FF,
  
  // 文本色系（反转）
  text-color-primary: #FFFFFF,
  text-color-secondary: #EBEBF5,
  text-color-placeholder: #8E8E93,
  text-color-disabled: #48484A,
  
  // 背景色系（深色）
  bg-color-page: #000000,
  bg-color-container: #1C1C1E,
  bg-color-mask: rgba(0, 0, 0, 0.7),
  
  // 边框色系（深色）
  border-color: #38383A,
  border-color-light: #2C2C2E,
  border-color-dark: #48484A
);
```

---

## 2. 主题配置方式

### 2.1 全局主题配置

在项目根目录创建 `theme.scss` 文件：

```scss
// theme.scss
// 自定义主题变量
$primary-color: #FF6B35;        // 橙色主题
$secondary-color: #4ECDC4;      // 青色辅助
$radius-base: 16px;             // 更大的圆角
$spacing-base: 16px;            // 更大的间距

// 导入组件库样式
@import 'kit-ui/styles/index.scss';
```

### 2.2 运行时主题切换

```typescript
// 主题管理器
class ThemeManager {
  private currentTheme: 'light' | 'dark' = 'light';
  
  // 切换主题
  toggleTheme() {
    this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
    this.applyTheme();
  }
  
  // 应用主题
  private applyTheme() {
    const root = document.documentElement;
    
    if (this.currentTheme === 'dark') {
      root.classList.add('k-theme-dark');
    } else {
      root.classList.remove('k-theme-dark');
    }
    
    // 存储主题偏好
    uni.setStorageSync('theme', this.currentTheme);
  }
  
  // 初始化主题
  initTheme() {
    const savedTheme = uni.getStorageSync('theme') || 'light';
    this.currentTheme = savedTheme;
    this.applyTheme();
  }
}

// 使用示例
const themeManager = new ThemeManager();
themeManager.initTheme();
```

### 2.3 组件级主题定制

```vue
<!-- 单个组件主题定制 -->
<template>
  <k-button 
    :theme-vars="customTheme"
    type="primary"
  >
    自定义主题按钮
  </k-button>
</template>

<script setup>
const customTheme = {
  '--k-primary-color': '#FF6B35',
  '--k-radius-base': '20px'
};
</script>
```

---

## 3. 跨端主题适配

### 3.1 条件编译主题

```scss
// 不同平台的主题适配
.k-button {
  // 基础样式
  padding: $spacing-base;
  border-radius: $radius-base;
  
  // H5 平台特殊样式
  /* #ifdef H5 */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all $animation-duration-base $animation-timing-function;
  
  &:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  /* #endif */
  
  // 小程序平台适配
  /* #ifdef MP */
  // 小程序不支持 box-shadow，使用边框模拟
  border: 1px solid rgba(0, 0, 0, 0.1);
  /* #endif */
  
  // App 平台适配
  /* #ifdef APP-PLUS */
  // App 平台可以使用原生阴影
  elevation: 2; // Android 阴影
  /* #endif */
}
```

### 3.2 响应式主题

```scss
// 响应式主题适配
.u-container {
  padding: $spacing-base;
  
  // 平板适配
  @media (min-width: 768px) {
    padding: $spacing-lg;
    max-width: 1200px;
    margin: 0 auto;
  }
  
  // 桌面端适配
  @media (min-width: 1024px) {
    padding: $spacing-xl;
  }
}
```

---

## 4. 主题开发最佳实践

### 4.1 主题变量命名规范

```scss
// ✅ 推荐：语义化命名
$primary-color: #007AFF;
$text-color-primary: #000000;
$bg-color-container: #FFFFFF;

// ❌ 不推荐：颜色值命名
$blue: #007AFF;
$black: #000000;
$white: #FFFFFF;
```

### 4.2 主题兼容性检查

```typescript
// 主题兼容性检测工具
class ThemeCompatibility {
  // 检查 CSS 变量支持
  static checkCSSVariableSupport(): boolean {
    return window.CSS && window.CSS.supports && window.CSS.supports('color', 'var(--test)');
  }
  
  // 检查暗色模式支持
  static checkDarkModeSupport(): boolean {
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  }
  
  // 获取系统主题偏好
  static getSystemThemePreference(): 'light' | 'dark' {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return 'light';
  }
}
```

### 4.3 主题性能优化

```scss
// 使用 CSS 变量减少重复计算
:root {
  --u-primary-color: #{$primary-color};
  --u-primary-color-light: #{lighten($primary-color, 10%)};
  --u-primary-color-dark: #{darken($primary-color, 10%)};
}

.u-button--primary {
  background-color: var(--u-primary-color);
  
  &:hover {
    background-color: var(--u-primary-color-light);
  }
  
  &:active {
    background-color: var(--u-primary-color-dark);
  }
}
```

---

## 5. 主题调试工具

### 5.1 主题预览组件

```vue
<!-- ThemePreview.vue -->
<template>
  <view class="theme-preview">
    <view class="theme-preview__header">
      <text class="theme-preview__title">主题预览</text>
      <u-switch v-model="isDark" @change="toggleTheme" />
    </view>
    
    <view class="theme-preview__content">
      <!-- 颜色面板 -->
      <view class="color-panel">
        <view 
          v-for="color in colorList" 
          :key="color.name"
          class="color-item"
          :style="{ backgroundColor: color.value }"
        >
          <text class="color-name">{{ color.name }}</text>
        </view>
      </view>
      
      <!-- 组件预览 -->
      <view class="component-preview">
        <u-button type="primary">主要按钮</u-button>
        <u-button type="default">默认按钮</u-button>
        <u-input placeholder="请输入内容" />
        <u-card title="卡片标题">卡片内容</u-card>
      </view>
    </view>
  </view>
</template>

<script setup>
import { ref, computed } from 'vue';

const isDark = ref(false);

const colorList = computed(() => [
  { name: '主色', value: 'var(--u-primary-color)' },
  { name: '成功色', value: 'var(--u-success-color)' },
  { name: '警告色', value: 'var(--u-warning-color)' },
  { name: '错误色', value: 'var(--u-error-color)' }
]);

function toggleTheme() {
  // 切换主题逻辑
}
</script>
```

### 5.2 主题变量提取工具

```javascript
// 主题变量提取脚本
const fs = require('fs');
const path = require('path');

class ThemeExtractor {
  static extractVariables(scssFile) {
    const content = fs.readFileSync(scssFile, 'utf-8');
    const variableRegex = /\$([\w-]+):\s*([^;]+);/g;
    const variables = {};
    
    let match;
    while ((match = variableRegex.exec(content)) !== null) {
      variables[match[1]] = match[2].trim();
    }
    
    return variables;
  }
  
  static generateThemeConfig(variables) {
    const config = {
      colors: {},
      sizes: {},
      spacing: {},
      typography: {}
    };
    
    Object.entries(variables).forEach(([key, value]) => {
      if (key.includes('color')) {
        config.colors[key] = value;
      } else if (key.includes('size') || key.includes('radius')) {
        config.sizes[key] = value;
      } else if (key.includes('spacing')) {
        config.spacing[key] = value;
      } else if (key.includes('font')) {
        config.typography[key] = value;
      }
    });
    
    return config;
  }
}
```

---

## 6. 常见问题与解决方案

### 6.1 主题切换闪烁问题

```typescript
// 解决方案：预加载主题样式
class ThemeLoader {
  static preloadTheme(theme: 'light' | 'dark') {
    const link = document.createElement('link');
    link.rel = 'preload';
    link.as = 'style';
    link.href = `/themes/${theme}.css`;
    document.head.appendChild(link);
  }
  
  static async switchTheme(theme: 'light' | 'dark') {
    // 添加过渡类
    document.body.classList.add('theme-transition');
    
    // 切换主题
    document.documentElement.setAttribute('data-theme', theme);
    
    // 移除过渡类
    setTimeout(() => {
      document.body.classList.remove('theme-transition');
    }, 300);
  }
}
```

### 6.2 小程序主题适配

```scss
// 小程序主题变量注入
/* #ifdef MP */
page {
  --u-primary-color: #007AFF;
  --u-text-color: #000000;
  --u-bg-color: #FFFFFF;
}

page.dark {
  --u-primary-color: #007AFF;
  --u-text-color: #FFFFFF;
  --u-bg-color: #000000;
}
/* #endif */
```

---

## 7. 主题测试

### 7.1 主题单元测试

```typescript
// theme.test.ts
import { ThemeManager } from '../src/theme/ThemeManager';

describe('ThemeManager', () => {
  let themeManager: ThemeManager;
  
  beforeEach(() => {
    themeManager = new ThemeManager();
  });
  
  test('should toggle theme correctly', () => {
    expect(themeManager.getCurrentTheme()).toBe('light');
    
    themeManager.toggleTheme();
    expect(themeManager.getCurrentTheme()).toBe('dark');
    
    themeManager.toggleTheme();
    expect(themeManager.getCurrentTheme()).toBe('light');
  });
  
  test('should apply theme variables', () => {
    const customTheme = {
      primaryColor: '#FF6B35',
      radiusBase: '16px'
    };
    
    themeManager.setCustomTheme(customTheme);
    const appliedTheme = themeManager.getAppliedTheme();
    
    expect(appliedTheme.primaryColor).toBe('#FF6B35');
    expect(appliedTheme.radiusBase).toBe('16px');
  });
});
```

### 7.2 视觉回归测试

```typescript
// visual-regression.test.ts
import { test, expect } from '@playwright/test';

test.describe('Theme Visual Tests', () => {
  test('light theme components', async ({ page }) => {
    await page.goto('/theme-preview?theme=light');
    await expect(page).toHaveScreenshot('light-theme.png');
  });
  
  test('dark theme components', async ({ page }) => {
    await page.goto('/theme-preview?theme=dark');
    await expect(page).toHaveScreenshot('dark-theme.png');
  });
  
  test('theme transition', async ({ page }) => {
    await page.goto('/theme-preview');
    
    // 切换到暗色主题
    await page.click('[data-testid="theme-toggle"]');
    await page.waitForTimeout(300); // 等待过渡动画
    
    await expect(page).toHaveScreenshot('theme-transition.png');
  });
});
```

---

## 8. 主题发布与维护

### 8.1 主题包发布

```json
{
  "name": "@u-kit/theme-orange",
  "version": "1.0.0",
  "description": "u-kit 橙色主题包",
  "main": "dist/index.css",
  "files": [
    "dist",
    "src"
  ],
  "peerDependencies": {
    "@u-kit/core": "^1.0.0"
  }
}
```

### 8.2 主题版本管理

```typescript
// 主题版本兼容性检查
class ThemeVersionManager {
  static checkCompatibility(themeVersion: string, coreVersion: string): boolean {
    // 语义化版本检查逻辑
    return semver.satisfies(coreVersion, themeVersion);
  }
  
  static migrateTheme(oldTheme: any, targetVersion: string): any {
    // 主题迁移逻辑
    const migrations = {
      '1.0.0': (theme) => theme,
      '1.1.0': (theme) => ({ ...theme, newProperty: 'defaultValue' }),
      '2.0.0': (theme) => this.migrateToV2(theme)
    };
    
    return migrations[targetVersion]?.(oldTheme) || oldTheme;
  }
}
```

通过以上主题定制系统，u-kit 组件库能够提供灵活、强大的主题定制能力，满足不同项目的视觉需求，同时保证跨端一致性和开发效率。
